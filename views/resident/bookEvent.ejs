<%- layout("layouts/boilerplate") %>

<style>
/* —————————————  BASE RULES (your originals)  ————————————— */
p{margin-bottom:0 !important;}

.info-right{min-width:100px;}

.action-icons a{text-decoration:none;transition:transform .2s,color .2s;}
.action-icons a:hover{transform:translateY(-2px) scale(1.1);}
.action-icons i{cursor:pointer;}

.event-info{transition:box-shadow .3s;}
.event-info:hover{box-shadow:0 8px 20px rgba(0,0,0,.08);}

/* Enhanced mobile event card styles */
.event-card-mobile {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    margin: 12px;
    overflow: hidden;
    display: none; /* Hidden by default */
}

.event-header-mobile {
    padding: 16px;
    border-bottom: 1px solid #f1f3f4;
}

.event-body-mobile {
    padding: 16px;
}

.event-footer-mobile {
    padding: 12px 16px;
    background: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.event-details-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
}

.event-detail-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: #6b7280;
}

.event-detail-item i {
    width: 16px;
    flex-shrink: 0;
}

.status-badge-mobile {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-approved { background: #d1f2eb; color: #0f6848; }
.status-pending { background: #fef3c7; color: #92400e; }
.status-rejected { background: #fee2e2; color: #991b1b; }

/* ===================================================================== */
/* ======================  RESPONSIVE MEDIA QUERIES  ==================== */
/* ===================================================================== */

/* ========== 1. MOBILE SMALL – 320-480 px  ========== */
@media screen and (min-width:320px) and (max-width:480px){
  /* global container spacing */
  .event-container{padding:10px;}
  
  /* page header ------------------------------------------------------- */
  .com-header{flex-direction:column;gap:10px;text-align:left}
  .com-header h2{font-size:1.35rem}
  .com-header p{font-size:.8rem}
  .com-header .right a{
    width:100%;display:block;text-align:center;
    padding:8px 14px;font-size:.8rem
  }

  /* venue cards ------------------------------------------------------- */
  .row.g-4{margin:0}
  .col-md-3{flex:0 0 100%;max-width:100%;margin-bottom:10px}
  .border.rounded-4.p-3{padding:14px !important}

  /* IMPROVED upcoming-events list ------------------------------------ */
  .upcoming-events{margin-top:20px !important;}
  .event-info-title h2{font-size:1.3rem;margin:15px !important;}
  
  /* Hide desktop event-info, show mobile version */
  .event-info{display:none !important;}
  .event-card-mobile{display:block !important;}
  
  /* Mobile event card layout */
  .event-card-mobile{
    margin:10px;
    box-shadow:0 2px 4px rgba(0,0,0,.1);
  }
  
  .event-header-mobile{
    padding:12px;
    border-bottom:1px solid #f1f3f4;
  }
  
  .event-header-mobile h5{
    font-size:1.1rem;
    margin-bottom:4px;
    font-weight:600;
    color:#1f2937;
    line-height:1.3;
  }
  
  .event-body-mobile{
    padding:12px;
  }
  
  .event-details-grid{
    gap:6px;
  }
  
  .event-detail-item{
    font-size:.8rem;
    gap:6px;
  }
  
  .event-detail-item i{
    font-size:.8rem;
    width:14px;
  }
  
  .event-footer-mobile{
    padding:10px 12px;
    flex-direction:row;
    justify-content:space-between;
    align-items:center;
  }
  
  .status-badge-mobile{
    font-size:.7rem;
    padding:3px 8px;
  }
  
  .action-icons{
    gap:10px;
  }
  
  .action-icons i{
    font-size:.9rem;
  }
  
  .organizer-info{
    font-size:.75rem;
    color:#6b7280;
    margin-top:8px;
    padding-top:8px;
    border-top:1px solid #f1f3f4;
  }
}

/* ========== 2. MOBILE MEDIUM / LARGE – 481-575 px  ========== */
@media screen and (min-width:481px) and (max-width:575px){
  /* venue cards: 2-per-row */
  .col-md-3{flex:0 0 50%;max-width:50%}
  
  /* Enhanced mobile event cards */
  .event-info{display:none !important;}
  .event-card-mobile{display:block !important;}
  
  .event-header-mobile h5{font-size:1.15rem;}
  .event-detail-item{font-size:.85rem;}
  .status-badge-mobile{font-size:.75rem;}
}

/* ========== 3. MOBILE LARGE – 576-767 px  (Bootstrap "sm") ========== */
@media screen and (min-width:576px) and (max-width:767px){
  .event-container{padding:12px}

  .com-header{flex-direction:column;gap:12px}
  .com-header h2{font-size:1.5rem}
  .com-header p{font-size:.9rem}
  .com-header .right a{width:auto;align-self:flex-start;padding:10px 18px}

  /* 2 venue cards per row */
  .col-md-3{flex:0 0 50%;max-width:50%}

  /* Enhanced mobile event cards for larger mobile */
  .event-info{display:none !important;}
  .event-card-mobile{display:block !important;}
  
  .event-card-mobile{
    margin:15px;
  }
  
  .event-header-mobile{padding:16px;}
  .event-header-mobile h5{font-size:1.2rem;}
  .event-body-mobile{padding:16px;}
  .event-detail-item{font-size:.9rem;}
}

/* ========== 4. TABLET SMALL – 768-991 px  (Bootstrap "md") ========== */
@media screen and (min-width:768px) and (max-width:991px){
  .event-container{padding:18px}
  .com-header h2{font-size:1.8rem}

  /* keep only 2 venue cards per row instead of Bootstrap's 4 */
  .col-md-3{flex:0 0 50%;max-width:50%}

  .border.rounded-4.p-3{padding:18px !important}

  /* Show desktop layout for tablets */
  .event-card-mobile{display:none !important;}
  .event-info{
    display:flex !important;
    flex-direction:row;gap:0;margin:20px
  }
  .info-left{margin-left:20px}
  .info-right{margin-right:20px}
}

/* ========== 5. TABLET LARGE – 992-1023 px  ========== */
@media screen and (min-width:992px) and (max-width:1023px){
  /* optional: use three cards per row instead of four */
  .col-md-3{flex:0 0 33.333%;max-width:33.333%}
  
  /* Desktop layout */
  .event-card-mobile{display:none !important;}
  .event-info{display:flex !important;}
}

/* ========== 6. DESKTOP – 1024px and above ========== */
@media screen and (min-width:1024px){
  .event-card-mobile{display:none !important;}
  .event-info{display:flex !important;}
}

/* ========== 7. MOBILE LANDSCAPE helper – height < 600 px ========== */
@media screen and (orientation:landscape) and (max-height:600px) and (max-width:767px){
  .event-card-mobile{display:block !important;margin:8px;}
  .event-info{display:none !important;}
  .event-header-mobile{padding:10px;}
  .event-body-mobile{padding:10px;}
}

/* —— utility: cancel Bootstrap's .ms-4 left-margin inside event list — */
@media screen and (max-width:767px){
  .event-info .info-left.ms-4{margin-left:0 !important}
}
</style>

<body>
  <div class="event-container">
    <div class="com-header d-flex justify-content-between">
      <div class="left">
        <h2 class="fw-bold">Event Booking</h2>
        <p class="text-muted">Book venues for your events and celebrations</p>
      </div>
      <div class="right d-flex align-items-center ">
        <a href="/resident/bookEvent/book"
          class="rounded p-2 px-4 text-white bg-primary border-0 text-decoration-none">
          <i class="bi bi-plus text-white"></i> Book Event
        </a>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <div class="row g-4">
      <% const today = new Date().toISOString().split('T')[0]; %>

      <!-- Club House Card -->
      <div class="col-md-3 col-sm-6">
        <div class="border rounded-4 p-3 bg-white h-100 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h6 class="fw-bold mb-0">Club House</h6>
            <i class="bi bi-geo-alt text-primary"></i>
          </div>
          <div class="text-muted mb-1">
            <i class="bi bi-people me-1"></i> Capacity: 100 people
          </div>

          <% const isBookedToday1 = eventDetails.some(e => {
            const eventDate = new Date(e.date).toISOString().split('T')[0];
            return eventDate === today && e.venue === "Club House";
          }); %>

          <div class="<%= isBookedToday1 ? 'text-danger' : 'text-success' %> mb-3">
            <% if (isBookedToday1) { %>
              <i class="bi bi-calendar-check me-1"></i> Not-Available Today
            <% } else { %>
              <i class="bi bi-calendar-check me-1"></i> Available Today
            <% } %>
          </div>

          <button
            type="button"
            class="btn btn-sm btn-primary-subtle bg-primary bg-opacity-25 text-primary w-100 py-2 mt-3"
            data-bs-toggle="modal"
            data-bs-target="#calendarModal"
            data-venue="Club House">
            Check Availability
          </button>
        </div>
      </div>

      <!-- Garden Area Card -->
      <div class="col-md-3 col-sm-6">
        <div class="border rounded-4 p-3 bg-white h-100 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h6 class="fw-bold mb-0">Garden Area</h6>
            <i class="bi bi-geo-alt text-primary"></i>
          </div>
          <div class="text-muted mb-1">
            <i class="bi bi-people me-1"></i> Capacity: 200 people
          </div>

          <% const isBookedToday2 = eventDetails.some(e => {
            const eventDate = new Date(e.date).toISOString().split('T')[0];
            return eventDate === today && e.venue === "Garden";
          }); %>

          <div class="<%= isBookedToday2 ? 'text-danger' : 'text-success' %> mb-3">
            <% if (isBookedToday2) { %>
              <i class="bi bi-calendar-check me-1"></i> Not-Available Today
            <% } else { %>
              <i class="bi bi-calendar-check me-1"></i> Available Today
            <% } %>
          </div>

          <button
            type="button"
            class="btn btn-sm btn-primary-subtle bg-primary bg-opacity-25 text-primary w-100 py-2 mt-3"
            data-bs-toggle="modal"
            data-bs-target="#calendarModal"
            data-venue="Garden Area">
            Check Availability
          </button>
        </div>
      </div>

      <!-- Community Hall Card -->
      <div class="col-md-3 col-sm-6">
        <div class="border rounded-4 p-3 bg-white h-100 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h6 class="fw-bold mb-0">Community Hall</h6>
            <i class="bi bi-geo-alt text-primary"></i>
          </div>
          <div class="text-muted mb-1">
            <i class="bi bi-people me-1"></i> Capacity: 150 people
          </div>

          <% const isBookedToday3 = eventDetails.some(e => {
            const eventDate = new Date(e.date).toISOString().split('T')[0];
            return eventDate === today && e.venue === "Community Hall";
          }); %>

          <div class="<%= isBookedToday3 ? 'text-danger' : 'text-success' %> mb-3">
            <% if (isBookedToday3) { %>
              <i class="bi bi-calendar-check me-1"></i> Not-Available Today
            <% } else { %>
              <i class="bi bi-calendar-check me-1"></i> Available Today
            <% } %>
          </div>

          <button
            type="button"
            class="btn btn-sm btn-primary-subtle bg-primary bg-opacity-25 text-primary w-100 py-2 mt-3"
            data-bs-toggle="modal"
            data-bs-target="#calendarModal"
            data-venue="Community Hall">
            Check Availability
          </button>
        </div>
      </div>

      <!-- Terrace Garden Card -->
      <div class="col-md-3 col-sm-6">
        <div class="border rounded-4 p-3 bg-white h-100 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h6 class="fw-bold mb-0">Terrace Garden</h6>
            <i class="bi bi-geo-alt text-primary"></i>
          </div>
          <div class="text-muted mb-1">
            <i class="bi bi-people me-1"></i> Capacity: 80 people
          </div>

          <% const isBookedToday4 = eventDetails.some(e => {
            const eventDate = new Date(e.date).toISOString().split('T')[0];
            return eventDate === today && e.venue === "Terrace Garden";
          }); %>

          <div class="<%= isBookedToday4 ? 'text-danger' : 'text-success' %> mb-3">
            <% if (isBookedToday4) { %>
              <i class="bi bi-calendar-check me-1"></i> Not-Available Today
            <% } else { %>
              <i class="bi bi-calendar-check me-1"></i> Available Today
            <% } %>
          </div>

          <button
            type="button"
            class="btn btn-sm btn-primary-subtle bg-primary bg-opacity-25 text-primary w-100 py-2 mt-3"
            data-bs-toggle="modal"
            data-bs-target="#calendarModal"
            data-venue="Terrace Garden">
            Check Availability
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upcoming Events -->
  <div class="upcoming-events border rounded mt-4 bg-white">
    <div class="event-info-title">
      <h2 class="m-4">Upcoming Events</h2>
    </div>
    
    <% eventDetails.forEach(event => { %>
      <!-- DESKTOP/TABLET VIEW -->
      <div class="event-info border rounded d-flex justify-content-between m-4">
        <div class="info-left ms-4 py-4">
          <h5 class="fw-bold mb-3"><%= event.title %></h5>
          <p class="text-muted"><i class="bi bi-calendar-check me-1 text-muted"></i> <%= event.date.toISOString().split('T')[0] %></p>
          <p class="text-muted"><i class="bi bi-clock text-muted"></i> <%= event.startTime %> - <%= event.endTime %></p>
          <p class="text-muted"><i class="bi bi-geo-alt text-muted"></i> <%= event.venue %></p>
          <p class="text-muted"><i class="bi bi-person text-muted"></i> <%= event.attendees %> attendees</p>
          <p class="mt-3"><b>Organized by</b> : <%= event.createdBy.first_name %> <%= event.createdBy.last_name %></p>
        </div>
        <div class="info-right mt-4 me-4">
          <% if (event.status === "Approved") { %>
            <p class="text-success fw-bold">Approved</p>
          <% } else if (event.status === "Pending") { %>
            <p class="text-warning fw-bold">Pending</p>
          <% } else { %>
            <p class="text-danger fw-bold">Rejected</p>
          <% } %>
          <div class="action-icons d-flex gap-4 mt-3">
            <a href="/resident/bookEvent/<%= event._id %>/edit" class="text-primary icon-link" title="Edit">
              <i class="bi bi-pencil fs-5"></i>
            </a>
            <form action="/resident/bookEvent/<%= event._id %>?_method=DELETE" method="POST" style="display:inline;">
              <button type="submit" class="btn p-0 border-0 bg-transparent text-danger icon-link" title="Delete">
                <i class="bi bi-trash fs-5"></i>
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- MOBILE VIEW -->
      <div class="event-card-mobile">
        <div class="event-header-mobile">
          <h5><%= event.title %></h5>
        </div>
        
        <div class="event-body-mobile">
          <div class="event-details-grid">
            <div class="event-detail-item">
              <i class="bi bi-calendar-check"></i>
              <span><%= event.date.toISOString().split('T')[0] %></span>
            </div>
            
            <div class="event-detail-item">
              <i class="bi bi-clock"></i>
              <span><%= event.startTime %> - <%= event.endTime %></span>
            </div>
            
            <div class="event-detail-item">
              <i class="bi bi-geo-alt"></i>
              <span><%= event.venue %></span>
            </div>
            
            <div class="event-detail-item">
              <i class="bi bi-person"></i>
              <span><%= event.attendees %> attendees</span>
            </div>
          </div>
          
          <div class="organizer-info">
            <strong>Organized by:</strong> <%= event.createdBy.first_name %> <%= event.createdBy.last_name %>
          </div>
        </div>
        
        <div class="event-footer-mobile">
          <% if (event.status === "Approved") { %>
            <span class="status-badge-mobile status-approved">Approved</span>
          <% } else if (event.status === "Pending") { %>
            <span class="status-badge-mobile status-pending">Pending</span>
          <% } else { %>
            <span class="status-badge-mobile status-rejected">Rejected</span>
          <% } %>
          
          <div class="action-icons d-flex">
            <a href="/resident/bookEvent/<%= event._id %>/edit" class="text-primary" title="Edit">
              <i class="bi bi-pencil"></i>
            </a>
            <form action="/resident/bookEvent/<%= event._id %>?_method=DELETE" method="POST" style="display:inline;">
              <button type="submit" class="btn p-0 border-0 bg-transparent text-danger" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    <% }); %>
  </div>

  <!-- Calendar Modal -->
  <div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="calendarModalLabel">Check Availability</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="event-date">Select Date:</label>
          <input type="date" id="event-date" class="form-control">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Check</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const calendarModal = document.getElementById('calendarModal');
    let selectedVenue = "";

    calendarModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;
      selectedVenue = button.getAttribute('data-venue');
      const modalTitle = calendarModal.querySelector('.modal-title');
      modalTitle.textContent = `Check Availability - ${selectedVenue}`;
    });

    const checkBtn = calendarModal.querySelector('.btn-primary');
    checkBtn.addEventListener('click', async () => {
      const selectedDate = document.getElementById('event-date').value;

      if (!selectedDate) {
        alert("Please select a date.");
        return;
      }

      try {
        const response = await fetch('/check-availability', {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            venue: selectedVenue,
            date: selectedDate
          })
        });

        const result = await response.json();

        if (result.available) {
          alert(`✅ ${selectedVenue} is available on ${selectedDate}`);
        } else {
          alert(`❌ ${selectedVenue} is NOT available on ${selectedDate}`);
        }

      } catch (error) {
        console.error(error);
        alert("Something went wrong. Try again.");
      }
    });
  </script>
</body>
